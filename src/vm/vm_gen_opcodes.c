#include <stdio.h>
#include <stdint.h>
#include "vm_internal.h"
#include "vm_opcodes.in"
#include "vm_opcodes_traits.h"

static vm_opcode_traits_t traits[256];
static const char *mnemonics[256];

int main()
{
	FILE *fd = fopen("vm_opcodes.h", "w");
	
	fprintf(fd, "#ifndef __mette_vm_opcodes_h_included\n#define __mette_vm_opcodes_h_included\n\n");
	fprintf(fd, "/* NOTE: AUTOGENERATED FILE. All editions will be discarded. */\n\n");
	fprintf(fd, "typedef enum {\n");
	for (int index = 0; index < ARRAY_SIZE(opcodes); ++index) {
		int opcode = opcodes[index].opcode;
		fprintf(fd, "\t/* %s */\n", opcodes[index].description);
		fprintf(fd, "\tVMOP_%s\t\t= 0x%02X, /* %d -> %d */\n",
			opcodes[index].mnemonic, 
			opcode,
			opcodes[index].stack_in,
			opcodes[index].stack_out);
		traits[opcode].pop_count = opcodes[index].stack_in;
		traits[opcode].push_count = opcodes[index].stack_out;
		mnemonics[opcode] = opcodes[index].mnemonic;
	}
	fprintf(fd, "} vm_opcode_t;\n\n");
	fprintf(fd, "#endif // __mette_vm_opcodes_h_included\n\n");
	
	fclose(fd);
	
	fd = fopen("vm_opcodes_traits.tab", "w");
	
	fprintf(fd, "/* NOTE: AUTOGENERATED FILE. All editions will be discarded. */\n\n");
	fprintf(fd, "static const vm_opcode_traits_t vm_opcode_traits[256] = {\n");
	for (int index = 0; index < 256; ++index) {
		fprintf(fd, "\t{ .pop_count = %d, .push_count = %d, },\n", 
			traits[index].pop_count,
			traits[index].push_count);
	}
	fprintf(fd, "};\n\n");
	
	fd = fopen("vm_opcodes_switch.tab", "w");
	
	fprintf(fd, "/* NOTE: AUTOGENERATED FILE. All editions will be discarded. */\n\n");
	fprintf(fd, "static const unsigned short offtab[256] = {\n");
	for (int index = 0; index < 256; ++index) {
		if (mnemonics[index]) {
			fprintf(fd, "\t&&op_%s - &&op_invalid,\n", mnemonics[index]);
		} else {
			fprintf(fd, "\t0,\n");
		}
	}
	fprintf(fd, "};\n\n");
	
	return 0;
}


